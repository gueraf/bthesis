\chapter{Application} % and (Performance) Evaluation, Discussion of Results
\label{ch:4}
\chapterprecishere{"In theory, there is no difference between theory and practice. But, in practice, there is."}{\hfill -- Jan L.\ A.\ van de Snepscheut \cite{rosenberg_use_2007}}
%\chapterprecishere{"Don't lower your expectations to meet your performance. Raise your level of performance to meet your expectations."}{\hfill -- Ralph Marston \cite{jumpstartyourday}}
%\chapterprecishere{"I decided long ago to stick to what I know best. Other people understand parallel machines much better than I do; programmers should listen to them, not me, for guidance on how to deal with simultaneity."}{\hfill -- Donald Knuth (\cite{eetimes})}

The purpose of this chapter is to apply the developed methods to the Gray-Scott model. At first, systems for which analytic solutions are known are used to validate the individual components of the application. Afterwards simulations of the Gray-Scott model in two and three dimensions are used to illustrate the pattern formation mechanism. Last but by no means least results from performance analysis and optimization techniques applicable for the GPU implementation are discussed. 

\section{Validation}
\label{ch:validation}
\paragraph{Simple degradation} Probably the simplest chemical system one can think of is given as follows:

\begin{align}
\cee{A &->[k] \emptyset{}}
\label{eq:simpledeg}
\end{align}

The system consists solely of one reaction in which molecules of species A are degraded. The parameter $k$ determines the rate at which this process takes place. The corresponding ordinary differential equations is given as

\begin{align}
\frac{da}{dt} = - ka
\label{eq:deg_analytic}
\end{align}

Analogous to \cite{erban_practical_2007} initial condition $a(0) = 20$ (number of particles) and parameter $k = 0.1$ are chosen. 

An analytic solution can be obtained:
\begin{align}
a(t) = 20 \cdot \exp(-0.1t)
\end{align}

Figure \ref{fig:tau_dec_indiv} shows three individual trajectories generated by the tau-leaping algorithm with adaptive step size selection ($\epsilon = 0.05$), in figure \ref{fig:tau_dec_average} a plot of both the analytic solution \eqref{eq:deg_analytic} and the average of $128^3$ stochastic simulation runs is given. The maximum absolute error is 0.1974, the maximum relative error is 0.1138 for $t \in [0,40]$. 

\begin{figure}
\centering
\includegraphics[width=\textwidth]{images/tau_decaying_individual.eps}
\caption{Three independent realizations of the simple degradation system \eqref{eq:simpledeg}. Parameterization: $k = 0.1$, $a(0) = 20$, $\epsilon = 0.05$}
\label{fig:tau_dec_indiv}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth]{images/tau_decaying_average.eps}
\caption{Analytic solution of the simple degradation system \eqref{eq:simpledeg} and average of $128^3=2097152$ tau-leaping simulations. }
\label{fig:tau_dec_average}
\end{figure}


\paragraph{Production and degradation} Another system that is commonly used to validate stochastic simulation algorithms is the production-degradation system:

\begin{align}
\label{eq:gendeg1}
\cee{A &->[k_1] \emptyset{}} \\
\label{eq:gendeg2}
\cee{\emptyset{} &->[k_2] A}
\end{align}

For the reaction rates $k_1$ and $k_2$ values 0.1 and 1.0 are chosen, initial condition is $a(0) = 0$. Considering the two propensity functions $\alpha_1(t) = k_1 a(t)$ and $\alpha_2(t) = k_2$ it is trivial to see that the system is in equilibrium for $a=10$. The same observation can be made from the differential equation:
\begin{align}
\frac{da}{dt} = -k_1a+k2
\end{align}
The analytic solution is 
\begin{align}
a(t) = -10 \exp(-0.1t)+10
\end{align}

Figure \ref{fig:prod_deg_time} again shows a plot of the analytic solution and the average of ${128}^3$ tau-leaping simulations ($\epsilon = 0.05$). The maximum absolute error for $t \in [0,100]$ is 0.0525, the maximum relative error is 0.0525. In figure \ref{fig:prod_deg_hist} a histogram on the number of molecules at $t=100$ clearly shows the equilibrium for 10 particles. 

\begin{figure}
\centering
\includegraphics[width=\textwidth]{images/prod_deg_time.eps}
\caption{Analytic solution of the production-degradation system \eqref{eq:gendeg1}-\eqref{eq:gendeg2} and average of $128^3=2097152$ tau-leaping simulations. Parameterization: $k_1 = 0.1$, $k_2 = 1$, $a(0) = 0$, $\epsilon = 0.05$}
\label{fig:prod_deg_time}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth]{images/prod_deg_hist.eps}
\caption{Histogram of the production-degradation system \eqref{eq:gendeg1}-\eqref{eq:gendeg2}. Parameterization analogous to figure \ref{fig:prod_deg_time}. }
\label{fig:prod_deg_hist}
\end{figure}

\paragraph{2D heat equation} In order to validate the diffusion mechanism of the stochastic simulators the parabolic partial differential equation know as heat equation (in this context also called diffusion equation) is considered:
\begin{align}
\frac{\partial \rho(x,y,t)}{\partial t} = D \Delta \rho(x,y,t)=D\left(\frac{\partial^2 \rho(x,y,t)}{\partial x^2} + \frac{\partial^2 \rho(x,y,t)}{\partial y^2}\right)
\label{eq:heat}
\end{align}
$\rho(x,y,t)$ can either be considered the amount of heat or the concentration of some species at time $t$ in a point at $(x,y)$. The diffusion constant $D$ is a positive constant. To facilitate visualization two-dimensional diffusion is considered. 

The domain $\Omega$ shall be the unit square, i.e.} $x,y\in[0,1]$. The system is endowed with Dirichlet boundary conditions
\begin{align}
\rho(0,y,t)=\rho(x,0,t)=\rho(1,y,t)=\rho(x,1,t)=0 \;t>0
\label{eq:heatboundary}
\end{align}
and an initial distribution
\begin{align}
\rho(x,y,0) = \sin(x\pi) \cdot \sin(y\pi)
\label{eq:heatinit}
\end{align}

Under these conditions an analytic solution can be obtained:
\begin{align}
\rho(x,y,t) = \sin(x\pi= \cdot \sin(y\pi) \cdot \exp(-2\pi^2Dt)
\end{align}

Figures \ref{fig:diff_analytic} and \ref{fig:diff_stoch} show the state of the system ($D=10^{-3}$) at $t=60$ obtained by the analytic solution and tau-leaping stochastic simulation, respectively. For the latter 128x128 compartments, the accuracy control parameter $\epsilon = 0.05$ and the scaling constant $\Omega = 1000$ were used. 

The number of molecules is proportional to the volume integral over concentration. For the 2D case one has the following area integral: 
\begin{align}
C_{analytic} = \int_0^1 \int_0^1 \rho(x,y,60) = \frac{4}{\pi^2}\cdot \exp(-0.12\cdot \pi^2) \approx 0.12399
\end{align}
For the democratized stochastic approach it is equivalent to consider the sum over all compartments:
\begin{align}
C_{discrete} = \cdot \sum_{i,j} v_{i,j} \cdot \frac{x_{i,j}}{\Omega}
\end{align}
where $v$ is the volume of the compartment and $x$ the number of molecules in it. Considering the presented two-dimensional example with 128x128 uniform square-shaped compartments one has for the absolute error $\Delta C = \abs{C_{analytical} - C_{discrete}} \approx 1.4232\cdot10^{-5}$, for the relative error $\delta C = \Delta C / C_{analytic} \approx 1.1478\cdot 10^{-4}$.  

\begin{figure}
\centering
% l b r t
\includegraphics[trim = 15mm 0mm 10mm 35mm, clip, width=3cm,width=\textwidth]{images/diff_analytic.png}
\caption{Analytic solution of heat equation \eqref{eq:heat} for $D=10^{-3}$ with boundary condition \eqref{eq:heatboundary} and initial condition \eqref{eq:heatinit} at $t=60$.}
\label{fig:diff_analytic}
\end{figure}

\begin{figure}
\centering
% l b r t
\includegraphics[trim = 15mm 0mm 10mm 35mm, clip, width=3cm,width=\textwidth]{images/diff_stoch.png}
\caption{Stochastic solution of heat equation \eqref{eq:heat} for $D=10^{-3}$ with boundary condition \eqref{eq:heatboundary} and initial condition \eqref{eq:heatinit} at $t=60$. Parameterization: $\epsilon = 0.05$, $\Omega = 1000$, spacing h=1/127}
\label{fig:diff_stoch}
\end{figure}


%\section{Pattern formation in the Gray-Scott System}
\input{chapters/4application/41pattern}
%\section{Performance Analysis}
\input{chapters/4application/42performance}